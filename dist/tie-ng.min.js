/*!
 Tie-ng - http://develman.github.io/tiejs
 Licensed under the MIT license
 Copyright (c) 2014 Christoph Huppertz <huppertz.chr@gmail.com>, Georg Henkel <georg@develman.de>
 */
angular.module("tiejs-ang",["angular.css.injector"]).directive("tiejsForm",["cssInjector",function(a){return{restrict:"E",scope:{formName:"@formName",showRequiredAsterisk:"@showRequiredAsterisk",fields:"=fields",bindings:"=bindings",bindingSource:"=bindingSource",onSubmit:"=onSubmit",submitButtonId:"@submitButtonId",reloadFlag:"=reloadFlag"},template:"<form></form>",link:function(b,c,d){var e=function(a,c){b.bindings.forEach(function(b){var d=b[a.data.name];d&&c.push(d)})},f=function(b,c){var d=[],f=[],g=[],h=[],i=[],j=function(a){a.forEach(function(a){switch(a.type){case"color":e(a,d);break;case"date":e(a,f);break;case"time":e(a,g);break;case"wysiwyg":e(a,h);break;case"tags":e(a,i)}})},k={showRequiredAsterisk:b.showRequiredAsterisk,formName:b.formName,bindingSource:b.bindingSource,onSubmit:b.onSubmit},l=c.find("form");l.TieJS(k);var m=l.data("tiejs");b.fields.forEach(function(a){a.fieldData&&("field"===a.fieldType?m.addFields(a.fieldData):"column"===a.fieldType?m.addColumns(a.fieldData):console&&console.log("tiejs-directive: unknown type of field (only type -field- and -column- are allowed)"),j(a.fieldData))}),m.addBindings(b.bindings);var n=0,o=[];if(d.length>0){var p=l.find(".color");for(n=0;n<d.length;n++){var q=$(p[n]).colorpicker({color:"#"+b.bindingSource[d[n]]});q.on("changeColor",function(a){var c=a.color.toHex(),d=$(a.currentTarget).find("input").attr("name");b.bindingSource[d]=c.replace("#","")}),o.push(q)}}var r=[];if(f.length>0){var s=l.find(".date");for(n=0;n<f.length;n++){var t=$(s[n]).datetimepicker({locale:"de",showTodayButton:!0});t.on("dp.change",function(a){var c=$(a.currentTarget).find("input").attr("name");b.bindingSource[c]=a.date.format("DD.MM.YYYY")}),r.push(t)}}var u=[];if(g.length>0){var v=l.find(".time");for(n=0;n<g.length;n++){var w=$(v[n]).clockpicker({placement:"bottom",align:"left",autoclose:"true"}).find("input").change(function(){var a=$(this).attr("name");b.bindingSource[a]=$(this).val()});u.push(w)}}var x=[];if(h.length>0){var y=l.find(".wysiwyg");for(n=0;n<h.length;n++){var z=$(y[n]).summernote({height:400,onblur:function(a){var c=$(a.currentTarget).parent().prev("div.wysiwyg").attr("name");b.bindingSource[c]=$(this).code()},toolbar:[["style",["bold","italic","underline","strikethrough","clear"]],["font",["strikethrough"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]]]}),A=$(y[n]).attr("name");z.code(b.bindingSource[A]),x.push(z)}}var B=[];if(i.length>0){var C=l.find(".tags");for(n=0;n<i.length;n++){var D=$(C[n]).chosen({width:"100%"});D.change(function(a,c){var d=$(a.currentTarget).attr("name"),e=$(a.currentTarget).find("option:selected");if(c.selected)e.each(function(){b.bindingSource[d].push($(this).val())});else{var f=b.bindingSource[d].indexOf(c.deselected);b.bindingSource[d].splice(f,1)}}),B.push(D)}}a&&(o.length>0&&a.add("/public/js/lib/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css"),r.length>0&&a.add("/public/js/lib/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"),u.length>0&&a.add("/public/js/lib/clockpicker/dist/bootstrap-clockpicker.min.css"),B.length>0&&a.add("/public/js/lib/chosen/chosen.css"),x.length>0&&a.add("/public/js/lib/summernote/dist/summernote.css")),$("#"+b.submitButtonId).on("click",function(){l.trigger("submit")})};f(b,c,d),b.reloadFlag&&b.$watch("reloadFlag",function(){$(c).find("form").children().remove(),f(b,c,d)})}}}]);