/*!
 Tie-ng - http://develman.github.io/tiejs
 Licensed under the MIT license
 Copyright (c) 2014 Christoph Huppertz <huppertz.chr@gmail.com>, Georg Henkel <georg@develman.de>
 */
angular.module("tie-ng",["angular.css.injector"]).directive("tiejsForm",["$compile","cssInjector",function(a,b){return{restrict:"E",scope:{formName:"@formName",showRequiredAsterisk:"@showRequiredAsterisk",fields:"=fields",bindings:"=bindings",bindingSource:"=bindingSource",onSubmit:"=onSubmit",submitButtonId:"@submitButtonId",reloadFlag:"=reloadFlag"},template:"<form></form>",link:function(c,d,e){var f=function(a,b){c.bindings.forEach(function(c){var d=c[a.data.name];d&&b.push(d)})},g=function(c,d,e){var g=[],h=[],i=[],j=[],k=[],l=function(a){a.forEach(function(a){switch(a.type){case"color":f(a,g);break;case"date":f(a,h);break;case"time":f(a,i);break;case"wysiwyg":f(a,j);break;case"tags":f(a,k)}})},m={showRequiredAsterisk:c.showRequiredAsterisk,formName:c.formName,bindingSource:c.bindingSource,onSubmit:c.onSubmit},n=d.find("form");n.TieJS(m);var o=n.data("tiejs");c.fields.forEach(function(a){a.fieldData&&("field"===a.fieldType?o.addFields(a.fieldData):"column"===a.fieldType?o.addColumns(a.fieldData):console&&console.log("tie-ng-directive: unknown type of field (only type -field- and -column- are allowed)"),l(a.fieldData))}),o.addBindings(c.bindings);var p=0,q=[];if(g.length>0){var r=n.find(".color");for(p=0;p<g.length;p++){var s=$(r[p]).colorpicker({color:"#"+c.bindingSource[g[p]]});s.on("changeColor",function(a){var b=a.color.toHex(),d=$(a.currentTarget).find("input").attr("name");c.bindingSource[d]=b.replace("#","")}),q.push(s)}}var t=[];if(h.length>0){var u=n.find(".date");for(p=0;p<h.length;p++){var v=$(u[p]).datetimepicker({locale:"de",showTodayButton:!0});v.on("dp.change",function(a){var b=$(a.currentTarget).find("input").attr("name");c.bindingSource[b]=a.date.format("DD.MM.YYYY")}),t.push(v)}}var w=[];if(i.length>0){var x=n.find(".time");for(p=0;p<i.length;p++){var y=$(x[p]).clockpicker({placement:"bottom",align:"left",autoclose:"true"}).find("input").change(function(){var a=$(this).attr("name");c.bindingSource[a]=$(this).val()});w.push(y)}}var z=[];if(j.length>0){var A=n.find(".wysiwyg");for(p=0;p<j.length;p++){var B=$(A[p]).summernote({height:400,onblur:function(a){var b=$(a.currentTarget).parent().prev("div.wysiwyg").attr("name");c.bindingSource[b]=$(this).code()},toolbar:[["style",["bold","italic","underline","strikethrough","clear"]],["font",["strikethrough"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]]]}),C=$(A[p]).attr("name");B.code(c.bindingSource[C]),z.push(B)}}var D=[];if(k.length>0){var E=n.find(".tags");for(p=0;p<k.length;p++){var F=$(E[p]).chosen({width:"100%"});F.change(function(a,b){var d=$(a.currentTarget).attr("name"),e=$(a.currentTarget).find("option:selected");if(b.selected)e.each(function(){c.bindingSource[d].push($(this).val())});else{var f=c.bindingSource[d].indexOf(b.deselected);c.bindingSource[d].splice(f,1)}}),D.push(F)}}b&&(q.length>0&&b.add("/public/js/lib/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css"),t.length>0&&b.add("/public/js/lib/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"),w.length>0&&b.add("/public/js/lib/clockpicker/dist/bootstrap-clockpicker.min.css"),D.length>0&&b.add("/public/js/lib/chosen/chosen.css"),z.length>0&&b.add("/public/js/lib/summernote/dist/summernote.css")),$("#"+c.submitButtonId).on("click",function(){n.trigger("submit")});var G=d.find("form");a(G.contents())(c)};g(c,d,e),c.reloadFlag&&c.$watch("reloadFlag",function(){$(d).find("form").children().remove(),g(c,d,e)})}}}]);