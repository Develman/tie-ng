/*!
 Tie-ng - http://develman.github.io/tiejs
 Licensed under the MIT license
 Copyright (c) 2014 Christoph Huppertz <huppertz.chr@gmail.com>, Georg Henkel <georg@develman.de>
 */
angular.module("tie-ng",["angular.css.injector"]).directive("tiejsForm",["$compile","cssInjector","$http","$sce",function($compile,cssInjector,$http,$sce){return{restrict:"E",scope:{formName:"@formName",showRequiredAsterisk:"@showRequiredAsterisk",fields:"=fields",bindings:"=bindings",bindingSource:"=bindingSource",onSubmit:"=onSubmit",submitButtonId:"@submitButtonId",reloadFlag:"=reloadFlag",libraryOptions:"=libraryOptions"},template:"<form></form>",link:function(scope,element,attr){var self=this,addSpecifiedFieldToArray=function(a,b){scope.bindings.forEach(function(c){var d=c[a.data.name];d&&b.push(d)})},init=function(scope,element,attr){function prepareSettings(a,b,c){return a.wildcard&&c&&(b.url=b.url.replace(a.wildcard,encodeURIComponent(c))),b.type=a.type?a.type:"GET",b.contentType=a.contentType,b.headers=a.headers,c&&(b.data=JSON.stringify(c)),b}function createBloodhoundOptions(a,b){var c={datumTokenizer:b.tokens?Bloodhound.tokenizers.obj.whitespace(b.tokens):Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace};return 0===b.options.minLength&&(c.identify=function(a){return a.id}),b.remote?(c.remote=b.remote,scope.libraryOptions.typeahead.prepare&&(c.remote.prepare=function(a,b){var c=scope.libraryOptions.typeahead.prepare;return prepareSettings(c,b,a)})):b.prefetch?(c.prefetch=b.prefetch,scope.libraryOptions.typeahead.prepare&&(c.prefetch.prepare=function(a){var b=scope.libraryOptions.typeahead.prepare;return prepareSettings(b,a)})):c.local=b.local,c}function createAdditionalOptions(){var a={name:$elem.attr("name"),source:0===elemData.options.minLength?getSearchValOrAllIfKeyIsNull:bloodhounds[$elem.attr("name")]};return elemData.limit&&(a.limit=elemData.limit),elemData.async&&(a.async=elemData.async),elemData.templateHtml&&(a.templates=getCustomTemplate(elemData.templateHtml)),elemData.display&&(a.display=getDisplayLayout(elemData.display)),a}function getCustomTemplate(htmlTpl){var template={};return htmlTpl&&(htmlTpl.empty&&(template.empty=function(a){return htmlTpl.empty}),htmlTpl.pending&&(template.pending=function(a){return htmlTpl.pending}),htmlTpl.suggestion&&(template.suggestion=function(data){return eval(htmlTpl.suggestion)}),htmlTpl.header&&(template.header=function(data){return eval(htmlTpl.header)}),htmlTpl.footer&&(template.footer=function(data){return eval(htmlTpl.footer)})),template}function getDisplayLayout(display){return function(obj){var data=[],view=display.style;return display.items.forEach(function(item){data[item]=eval("obj."+item),view=view.replace(item,data[item])}),view}}function getSearchValOrAllIfKeyIsNull(a,b){var c=bloodhounds[$(this).attr("name")];""===a?b(c.all()):c.search(a,b)}function setValueToTypeaheadInput(a,b){var c=getBindingName(a,scope.bindings),d=getParentBindingObj(c),e=d.parentObj[d.childName],f="";if(e&&e.id)if(b.display){var g=[];f=b.display.style,b.display.items.forEach(function(a){g[a]=e[a],f=f.replace(a,g[a])})}else f=e[b.display];newTypeahead.typeahead("val",f)}var colorFieldNames=[],dateFieldNames=[],timeFieldNames=[],wysiwygFieldNames=[],tagFieldNames=[],typeaheadFieldNames=[],getBindingName=function(a,b){var c=null;return b.forEach(function(b){return c=b[a.attr("name")],c?c:void 0}),c},getBindingObj=function(bindingName){var tmp="scope.bindingSource";return""!==bindingName&&(tmp+="."+bindingName),eval(tmp)},getParentBindingObj=function(a){var b="";if(-1!=a.indexOf(".")){var c=a.lastIndexOf(".");b=a.substr(0,c),a=a.substr(c+1)}var d=getBindingObj(b);return{parentObj:d,childName:a}},checkIfDataHasSpecialField=function(a){a.forEach(function(a){switch(a.type){case"color":addSpecifiedFieldToArray(a,colorFieldNames);break;case"date":addSpecifiedFieldToArray(a,dateFieldNames);break;case"time":addSpecifiedFieldToArray(a,timeFieldNames);break;case"wysiwyg":addSpecifiedFieldToArray(a,wysiwygFieldNames);break;case"tags":addSpecifiedFieldToArray(a,tagFieldNames);break;case"typeahead":addSpecifiedFieldToArray(a,typeaheadFieldNames)}})},options={showRequiredAsterisk:scope.showRequiredAsterisk,formName:scope.formName,bindingSource:scope.bindingSource,onSubmit:scope.onSubmit},formElem=element.find("form");formElem.TieJS(options);var tiejsForm=formElem.data("tiejs");scope.fields.forEach(function(a){a.fieldData&&("field"===a.fieldType?tiejsForm.addFields(a.fieldData):"column"===a.fieldType?tiejsForm.addColumns(a.fieldData):console&&console.log("tie-ng-directive: unknown type of field (only type -field- and -column- are allowed)"),checkIfDataHasSpecialField(a.fieldData))}),tiejsForm.addBindings(scope.bindings);var i=0,colorPickers=[];if(colorFieldNames.length>0){var colorpickerElements=formElem.find(".color");for(i=0;i<colorFieldNames.length;i++){var colorpicker=$(colorpickerElements[i]).colorpicker({color:scope.bindingSource[colorFieldNames[i]],format:"hex"});colorpicker.on("changeColor",function(a){var b=a.color.toHex(),c=$(a.currentTarget).find("input").attr("name");scope.bindingSource[c]=b}),colorPickers.push(colorpicker)}}var datePickers=[];if(dateFieldNames.length>0){var datepickerElements=formElem.find(".date");for(i=0;i<dateFieldNames.length;i++){var datepicker=$(datepickerElements[i]).datetimepicker({locale:"de",showTodayButton:!0});datepicker.on("dp.change",function(a){var b=$(a.currentTarget).find("input").attr("name");scope.bindingSource[b]=a.date.format("DD.MM.YYYY")}),datePickers.push(datepicker)}}var timePickers=[];if(timeFieldNames.length>0){var timepickerElements=formElem.find(".time");for(i=0;i<timeFieldNames.length;i++){var clockpicker=$(timepickerElements[i]).clockpicker({placement:"bottom",align:"left",autoclose:"true"}).find("input").change(function(){var a=$(this).attr("name");scope.bindingSource[a]=$(this).val()});timePickers.push(clockpicker)}}var editorPickers=[];if(wysiwygFieldNames.length>0){var editorPickerElements=formElem.find(".wysiwyg");for(i=0;i<wysiwygFieldNames.length;i++){var editorpicker=$(editorPickerElements[i]).summernote({height:400,onKeyup:function(a){var b=getBindingName($(this),scope.bindings),c=getParentBindingObj(b);c.parentObj[c.childName]=$(this).code()},toolbar:[["style",["bold","italic","underline","strikethrough","clear"]],["font",["strikethrough"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]]]}),fieldName=$(editorPickerElements[i]).attr("name");editorpicker.code(scope.bindingSource[fieldName]),editorPickers.push(editorpicker)}}var tagFields=[];if(tagFieldNames.length>0){var tagElements=formElem.find(".tags");for(i=0;i<tagFieldNames.length;i++){var tagField=$(tagElements[i]).chosen({width:"100%"});tagField.change(function(a,b){var c=$(a.currentTarget).attr("name"),d=$(a.currentTarget).find("option:selected");if(b.selected)d.each(function(){scope.bindingSource[c].push($(this).val())});else{var e=scope.bindingSource[c].indexOf(b.deselected);scope.bindingSource[c].splice(e,1)}}),tagFields.push(tagField)}}var typeaheads=[],bloodhounds=[];if(typeaheadFieldNames.length>0){var typeaheadElements=formElem.find(".typeahead");for(i=0;i<typeaheadElements.length;i++){var $elem=$(typeaheadElements[i]),elemData=$elem.data("elemdata"),bloodhoundOptions=createBloodhoundOptions($elem,elemData);bloodhounds[$elem.attr("name")]=new Bloodhound(bloodhoundOptions),bloodhounds[$elem.attr("name")].initialize();var additonalOptions=createAdditionalOptions(),newTypeahead=$elem.typeahead(elemData.options?elemData.options:null,additonalOptions);typeaheads.push(newTypeahead),setValueToTypeaheadInput($elem,elemData),newTypeahead.bind("typeahead:select",function(a,b){var c=getBindingName($(this),scope.bindings),d=getParentBindingObj(c);d.parentObj[d.childName]=b}),newTypeahead.on("focus",function(){""===$(this).typeahead("val")&&($(this).typeahead("val","_"),$(this).typeahead("open"),$(this).typeahead("val",""))})}}cssInjector&&(colorPickers.length>0&&cssInjector.add("/public/js/lib/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css"),datePickers.length>0&&cssInjector.add("/public/js/lib/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"),timePickers.length>0&&cssInjector.add("/public/js/lib/clockpicker/dist/bootstrap-clockpicker.min.css"),tagFields.length>0&&cssInjector.add("/public/js/lib/chosen/chosen.css"),editorPickers.length>0&&cssInjector.add("/public/js/lib/summernote/dist/summernote.css")),$("#"+scope.submitButtonId).on("click",function(){formElem.trigger("submit")});var anguElem=element.find("form");$compile(anguElem.contents())(scope)};init(scope,element,attr),scope.reloadFlag&&scope.$watch("reloadFlag",function(){$(element).find("form").children().remove(),init(scope,element,attr)})}}}]);