/*!
 Tie-ng - http://develman.github.io/tiejs
 Licensed under the MIT license
 Copyright (c) 2014 Christoph Huppertz <huppertz.chr@gmail.com>, Georg Henkel <georg@develman.de>
 */
angular.module("tie-ng",["angular.css.injector"]).directive("tiejsForm",["$compile","cssInjector",function(a,b){return{restrict:"E",scope:{formName:"@formName",showRequiredAsterisk:"@showRequiredAsterisk",fields:"=fields",bindings:"=bindings",bindingSource:"=bindingSource",onSubmit:"=onSubmit",submitButtonId:"@submitButtonId",reloadFlag:"=reloadFlag"},template:"<form></form>",link:function(c,d,e){var f=function(a,b){c.bindings.forEach(function(c){var d=c[a.data.name];d&&b.push(d)})},g=function(c,d,e){var g=[],h=[],i=[],j=[],k=[],l=[],m=function(a){a.forEach(function(a){switch(a.type){case"color":f(a,g);break;case"date":f(a,h);break;case"time":f(a,i);break;case"wysiwyg":f(a,j);break;case"tags":f(a,k);break;case"typeahead":f(a,l)}})},n={showRequiredAsterisk:c.showRequiredAsterisk,formName:c.formName,bindingSource:c.bindingSource,onSubmit:c.onSubmit},o=d.find("form");o.TieJS(n);var p=o.data("tiejs");c.fields.forEach(function(a){a.fieldData&&("field"===a.fieldType?p.addFields(a.fieldData):"column"===a.fieldType?p.addColumns(a.fieldData):console&&console.log("tie-ng-directive: unknown type of field (only type -field- and -column- are allowed)"),m(a.fieldData))}),p.addBindings(c.bindings);var q=0,r=[];if(g.length>0){var s=o.find(".color");for(q=0;q<g.length;q++){var t=$(s[q]).colorpicker({color:"#"+c.bindingSource[g[q]]});t.on("changeColor",function(a){var b=a.color.toHex(),d=$(a.currentTarget).find("input").attr("name");c.bindingSource[d]=b.replace("#","")}),r.push(t)}}var u=[];if(h.length>0){var v=o.find(".date");for(q=0;q<h.length;q++){var w=$(v[q]).datetimepicker({locale:"de",showTodayButton:!0});w.on("dp.change",function(a){var b=$(a.currentTarget).find("input").attr("name");c.bindingSource[b]=a.date.format("DD.MM.YYYY")}),u.push(w)}}var x=[];if(i.length>0){var y=o.find(".time");for(q=0;q<i.length;q++){var z=$(y[q]).clockpicker({placement:"bottom",align:"left",autoclose:"true"}).find("input").change(function(){var a=$(this).attr("name");c.bindingSource[a]=$(this).val()});x.push(z)}}var A=[];if(j.length>0){var B=o.find(".wysiwyg");for(q=0;q<j.length;q++){var C=$(B[q]).summernote({height:400,onblur:function(a){var b=$(a.currentTarget).parent().prev("div.wysiwyg").attr("name");c.bindingSource[b]=$(this).code()},toolbar:[["style",["bold","italic","underline","strikethrough","clear"]],["font",["strikethrough"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]]]}),D=$(B[q]).attr("name");C.code(c.bindingSource[D]),A.push(C)}}var E=[];if(k.length>0){var F=o.find(".tags");for(q=0;q<k.length;q++){var G=$(F[q]).chosen({width:"100%"});G.change(function(a,b){var d=$(a.currentTarget).attr("name"),e=$(a.currentTarget).find("option:selected");if(b.selected)e.each(function(){c.bindingSource[d].push($(this).val())});else{var f=c.bindingSource[d].indexOf(b.deselected);c.bindingSource[d].splice(f,1)}}),E.push(G)}}var H=[];if(l.length>0){var I=o.find(".typeahead");for(q=0;q<I.length;q++){var J=$(I[q]),K=J.data("elemdata"),L={datumTokenizer:K.display?Bloodhound.tokenizers.obj.whitespace(K.display):Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:K.prefetch?K.prefetch:null};K.remote?L.remote={url:K.remote,wildcard:"%QUERY"}:L.local=K.local;var M=new Bloodhound(L),N=J.typeahead(K.options?K.options:null,{name:J.attr("name"),display:K.display?K.display:null,source:M,templates:K.templates?K.templates:null});H.push(N)}}b&&(r.length>0&&b.add("/public/js/lib/mjolnic-bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css"),u.length>0&&b.add("/public/js/lib/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"),x.length>0&&b.add("/public/js/lib/clockpicker/dist/bootstrap-clockpicker.min.css"),E.length>0&&b.add("/public/js/lib/chosen/chosen.css"),A.length>0&&b.add("/public/js/lib/summernote/dist/summernote.css")),$("#"+c.submitButtonId).on("click",function(){o.trigger("submit")});var O=d.find("form");a(O.contents())(c)};g(c,d,e),c.reloadFlag&&c.$watch("reloadFlag",function(){$(d).find("form").children().remove(),g(c,d,e)})}}}]);